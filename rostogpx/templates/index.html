<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ì§€ë„ ê²½ë¡œ GPX ìƒì„±ê¸°</title>
    <style>
        canvas {
            border: 1px solid #000;
            display: block;
            margin-bottom: 10px;
        }
        button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h2>ë„ë¡œë¥¼ ë”°ë¼ ì¶œë°œì§€ì™€ ëª©ì ì§€ë¥¼ ì§€ì •í•˜ì„¸ìš”</h2>
    <canvas id="mapCanvas" width="800" height="500"></canvas>
    <br>
    <button id="saveBtn">GPX ì €ì¥</button>
    <button id="clearBtn">ì´ˆê¸°í™”</button>
    <a id="downloadLink" style="display: none;" download="path.gpx">GPX ë‹¤ìš´ë¡œë“œ</a>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const points = [];

        const img = new Image();
        img.src = '/static/map.png';
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        canvas.addEventListener('click', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            points.push({ x: x, y: y });

            // Draw point
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();

            // Draw path
            if (points.length > 1) {
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(points[points.length - 2].x, points[points.length - 2].y);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            points.length = 0;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            document.getElementById('downloadLink').style.display = 'none';
        });

        document.getElementById('saveBtn').addEventListener('click', async () => {
            if (points.length < 2) {
                alert("ì¶œë°œì§€ì™€ ëª©ì ì§€ë¥¼ ì§€ì •í•˜ì„¸ìš”.");
                return;
            }

            try {
                const res = await fetch('/save_gpx', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ points: points })
                });

                const result = await res.json();

                if (result.filename) {
                    const link = document.getElementById('downloadLink');
                    link.href = `/download/${result.filename}`;
                    link.style.display = 'inline-block';
                    link.textContent = "ğŸ“¥ GPX ë‹¤ìš´ë¡œë“œ";
                } else {
                    alert("GPX ì €ì¥ ì‹¤íŒ¨: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                }
            } catch (error) {
                alert("GPX ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        });
    </script>
</body>
</html>
